<div class="main">
  <div class="container mx-auto px-4 py-8">
    <!-- Header and Date Controls -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Contribution Analysis</h1>
        <p class="text-gray-600" *ngIf="analysisData">
          Report generated on {{ analysisData.summary.reportDate }} for {{ analysisData.summary.reportPeriod }}
        </p>
      </div>

      <div class="flex flex-col sm:flex-row gap-4 w-full md:w-auto">
        <div>
          <label for="startDate" class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
          <input type="date" id="startDate" [(ngModel)]="startDate" (change)="onDateChange()"
            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
        </div>
        <div>
          <label for="endDate" class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
          <input type="date" id="endDate" [(ngModel)]="endDate" (change)="onDateChange()"
            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
        </div>
      </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="loading" class="flex justify-center items-center py-12">
      <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-orange-500"></div>
    </div>

    <!-- Error State -->
    <div *ngIf="error" class="bg-red-50 border-l-4 border-red-500 p-4 mb-6">
      <div class="flex">
        <div class="flex-shrink-0">
          <svg class="h-5 w-5 text-red-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd"
              d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
              clip-rule="evenodd" />
          </svg>
        </div>
        <div class="ml-3">
          <p class="text-sm text-red-700">{{ error }}</p>
        </div>
      </div>
    </div>

    <!-- Empty Data State -->
    <div *ngIf="!loading && !error && !hasData()" class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
      <div class="flex">
        <div class="flex-shrink-0">
          <svg class="h-5 w-5 text-yellow-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"
            fill="currentColor">
            <path fill-rule="evenodd"
              d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
              clip-rule="evenodd" />
          </svg>
        </div>
        <div class="ml-3">
          <p class="text-sm text-yellow-700">No contribution data found for the selected period
            ({{analysisData.period.startDate}} to {{analysisData.period.endDate}})</p>
        </div>
      </div>
    </div>

    <!-- Analysis Content -->
    <div *ngIf="!loading && !error && hasData()" class="space-y-8">
      <!-- Summary Cards -->
      <!-- Summary Cards -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
        <!-- Total Contributions Card -->
        <div
          class="bg-gradient-to-br from-white via-indigo-50 to-white p-6 rounded-2xl shadow-lg border border-indigo-100 transition-transform transform hover:scale-[1.02] group relative overflow-hidden">
          <div class="absolute -right-4 -top-4 text-indigo-100 text-7xl opacity-30">
            <fa-icon [icon]="faCoins"></fa-icon>
          </div>
          <h3 class="text-lg font-semibold text-gray-800 flex items-center gap-2 mb-2 relative z-10">
            <fa-icon [icon]="faCoins" class="text-indigo-500"></fa-icon>
            Total Contributions (Period)
          </h3>
          <p class="text-3xl font-bold text-indigo-700 mb-1 relative z-10">{{
            periodAmount}}</p>
          <div class="flex items-center text-sm text-gray-500 mt-1 relative z-10">
            <fa-icon [icon]="faCalendarAlt" class="mr-1"></fa-icon>
            <span>{{ analysisData.summary.analysisPeriod?.periodLabel }}</span>
          </div>
        </div>

        <!-- Total Expected Card -->
        <div
          class="bg-gradient-to-br from-white via-blue-50 to-white p-6 rounded-2xl shadow-lg border border-blue-100 hover:shadow-xl transition relative overflow-hidden">
          <div class="absolute -right-4 -top-4 text-blue-100 text-7xl opacity-30">
            <fa-icon [icon]="faBullseye"></fa-icon>
          </div>
          <h3 class="text-lg font-semibold text-gray-800 flex items-center gap-2 mb-2 relative z-10">
            <fa-icon [icon]="faBullseye" class="text-blue-500"></fa-icon>
            Total Expected
          </h3>
          <p class="text-3xl font-bold text-blue-600 mb-1 relative z-10">{{
            analysisData.summary.total_expected_contributions }}</p>
          <div class="flex items-center text-sm text-gray-500 mt-1 relative z-10">
            <fa-icon [icon]="faChartBar" class="mr-1"></fa-icon>
            <span>{{ analysisData.summary.quartersIncluded }} quarters included</span>
          </div>
        </div>

        <!-- Average Contributors Card -->
        <div
          class="bg-gradient-to-br from-white via-purple-50 to-white p-6 rounded-2xl shadow-lg border border-purple-100 hover:shadow-xl transition relative overflow-hidden">
          <div class="absolute -right-4 -top-4 text-purple-100 text-7xl opacity-30">
            <fa-icon [icon]="faUsers"></fa-icon>
          </div>
          <h3 class="text-lg font-semibold text-gray-800 flex items-center gap-2 mb-2 relative z-10">
            <fa-icon [icon]="faUsers" class="text-purple-500"></fa-icon>
            Average Contributors
          </h3>
          <p class="text-3xl font-bold text-purple-600 mb-1 relative z-10">{{
            analysisData.summary.average_contributors_per_month }}</p>
          <div class="flex items-center text-sm text-gray-500 mt-1 relative z-10">
            <fa-icon [icon]="faCalendarCheck" class="mr-1"></fa-icon>
            <span>{{ analysisData.insights.monthsAnalyzed }} months analyzed</span>
          </div>
        </div>

        <!-- Highest Contributor Card -->
        <div
          class="bg-gradient-to-br from-white via-green-50 to-white p-6 rounded-2xl shadow-lg border border-green-100 hover:shadow-xl transition relative overflow-hidden">
          <div class="absolute -right-4 -top-4 text-green-100 text-7xl opacity-30">
            <fa-icon [icon]="faCrown"></fa-icon>
          </div>
          <h3 class="text-lg font-semibold text-gray-800 flex items-center gap-2 mb-2 relative z-10">
            <fa-icon [icon]="faCrown" class="text-green-500"></fa-icon>
            Highest Contributor
          </h3>
          <p class="text-xl font-medium text-green-600 mb-1 relative z-10">
            {{ analysisData.summary.highest_contributor || 'None' }}
          </p>
          <div class="flex items-center text-sm text-gray-500 mt-1 relative z-10">
            <fa-icon [icon]="faTrophy" class="mr-1"></fa-icon>
            <span>Top performer</span>
          </div>
        </div>

        <!-- Best Month Card -->
        <div
          class="bg-gradient-to-br from-white via-amber-50 to-white p-6 rounded-2xl shadow-lg border border-amber-100 hover:shadow-xl transition relative overflow-hidden">
          <div class="absolute -right-4 -top-4 text-amber-100 text-7xl opacity-30">
            <fa-icon [icon]="faStar"></fa-icon>
          </div>
          <h3 class="text-lg font-semibold text-gray-800 flex items-center gap-2 mb-2 relative z-10">
            <fa-icon [icon]="faStar" class="text-amber-500"></fa-icon>
            Best Month
          </h3>
          <ng-container *ngIf="analysisData.insights.bestMonthOverall as bestMonth">
            <p class="text-xl font-semibold text-amber-600 mb-1 relative z-10">{{ bestMonth.monthName }}</p>
            <p class="text-gray-700 font-medium relative z-10">{{ bestMonth.amountFormatted }}</p>
            <div class="flex items-center text-sm text-gray-500 mt-1 relative z-10">
              <fa-icon [icon]="faPercent" class="mr-1"></fa-icon>
              <span>Collection rate: {{ bestMonth.collectionRate }}</span>
            </div>
          </ng-container>
          <ng-container *ngIf="!analysisData.insights.bestMonthOverall">
            <p class="text-gray-500 italic relative z-10">No best month data</p>
          </ng-container>
        </div>

        <!-- Trend Card -->
        <div
          class="bg-gradient-to-br from-white via-red-50 to-white p-6 rounded-2xl shadow-lg border border-red-100 hover:shadow-xl transition relative overflow-hidden">
          <div class="absolute -right-4 -top-4 text-red-100 text-7xl opacity-30">
            <fa-icon [icon]="faChartLine"></fa-icon>
          </div>
          <h3 class="text-lg font-semibold text-gray-800 flex items-center gap-2 mb-2 relative z-10">
            <fa-icon [icon]="faChartLine" class="text-red-500"></fa-icon>
            Trend Direction
          </h3>
          <div class="flex items-center mb-1 relative z-10">
            <span class="text-2xl font-bold text-red-600">
              {{ analysisData.insights.trendDirection }}
            </span>
            <fa-icon *ngIf="analysisData.insights.trendDirection === 'Improving'" [icon]="faArrowUp"
              class="h-5 w-5 text-green-500 ml-2"></fa-icon>
            <fa-icon *ngIf="analysisData.insights.trendDirection === 'Declining'" [icon]="faArrowDown"
              class="h-5 w-5 text-red-500 ml-2"></fa-icon>
          </div>
          <div class="flex items-center text-sm text-gray-500 mt-1 relative z-10">
            <fa-icon [icon]="faShieldAlt" class="mr-1"></fa-icon>
            <span>Consistency: {{ analysisData.insights.consistencyScore }}%</span>
          </div>
        </div>
      </div>


      <!-- Quarterly Analysis -->
      <div class="bg-white shadow-sm rounded-lg overflow-hidden border border-gray-100">
        <div class="px-6 py-4 border-b border-gray-100">
          <h2 class="text-xl font-semibold text-gray-800">Quarterly Analysis</h2>
          <p class="text-sm text-gray-500 mt-1">{{ analysisData.summary.analysisPeriod?.periodLabel }}</p>
        </div>
        <div class="divide-y divide-gray-100">
          <div *ngFor="let quarter of getQuarters()" class="p-6">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
              <div>
                <h3 class="text-lg font-medium text-gray-900">{{ quarter.quarterLabel }}</h3>
                <p class="text-sm text-gray-500">{{ quarter.monthsInQuarter }} months with data</p>
              </div>
              <div class="grid grid-cols-2 md:grid-cols-3 gap-4 w-full md:w-auto">
                <div class="text-right">
                  <p class="text-sm text-gray-500">Expected</p>
                  <p class="font-medium">{{ quarter.totalExpectedFormatted }}</p>
                </div>
                <div class="text-right">
                  <p class="text-sm text-gray-500">Collected</p>
                  <p class="font-medium">{{ quarter.totalCollectedFormatted }}</p>
                </div>
                <div class="text-right">
                  <p class="text-sm text-gray-500">Rate</p>
                  <p class="font-medium">{{ quarter.averageCollectionRate }}%</p>
                  <span class="text-xs px-2 inline-flex leading-5 font-semibold rounded-full 
                    {{ quarter.quarterPerformance === 'Excellent' ? 'bg-green-100 text-green-800' : 
                       quarter.quarterPerformance === 'Good' ? 'bg-blue-100 text-blue-800' :
                       quarter.quarterPerformance === 'Fair' ? 'bg-yellow-100 text-yellow-800' :
                       quarter.quarterPerformance === 'Poor' ? 'bg-orange-100 text-orange-800' :
                       'bg-red-100 text-red-800' }}">
                    {{ quarter.quarterPerformance }}
                  </span>
                </div>
              </div>
            </div>

            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th scope="col"
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Month
                    </th>
                    <th scope="col"
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Expected
                    </th>
                    <th scope="col"
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Collected
                    </th>
                    <th scope="col"
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rate</th>
                    <th scope="col"
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Contributors</th>
                    <th scope="col"
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Performance</th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  <tr *ngFor="let month of quarter.monthlyPerformance">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                      {{ month.monthName }}
                      <span *ngIf="month.isTopPerformer"
                        class="ml-2 inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-indigo-100 text-indigo-800">
                        Top
                      </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">KES {{
                      month.expected.toLocaleString() }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">KES {{
                      month.collected.toLocaleString() }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ month.collectionRate }}%</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ month.contributors }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                      <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                        {{ month.performance === 'Excellent' ? 'bg-green-100 text-green-800' : 
                           month.performance === 'Good' ? 'bg-blue-100 text-blue-800' :
                           month.performance === 'Fair' ? 'bg-yellow-100 text-yellow-800' :
                           month.performance === 'Poor' ? 'bg-orange-100 text-orange-800' :
                           'bg-red-100 text-red-800' }}">
                        {{ month.performance }}
                      </span>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Monthly Detailed Analysis -->
      <div class="bg-white shadow-sm rounded-lg overflow-hidden border border-gray-100">
        <div
          class="px-6 py-4 border-b border-gray-100 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
          <div>
            <h2 class="text-xl font-semibold text-gray-800">Monthly Detailed Analysis</h2>
            <p class="text-sm text-gray-500">{{ analysisData.monthly.length }} months analyzed</p>
          </div>
          <div *ngIf="analysisData.insights.bestMonthOverall as bestMonth"
            class="text-sm bg-indigo-50 px-3 py-1 rounded-md">
            <span class="font-medium text-indigo-800">Best Month:</span>
            <span class="text-indigo-600">{{ bestMonth.monthName }} ({{ bestMonth.amountFormatted }})</span>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Month</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Expected</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Collected
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Shortfall
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Rate</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Contributors
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Performance
                </th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              <tr *ngFor="let month of analysisData.monthly"
                [class.bg-indigo-50]="analysisData.insights.bestMonthOverall?.monthName === month.monthName">
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                  {{ month.monthName }}
                  <span *ngIf="analysisData.insights.bestMonthOverall?.monthName === month.monthName"
                    class="ml-2 inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-indigo-100 text-indigo-800">
                    Best
                  </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ month.expected }}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ month.collected }}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ month.shortfall }}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ month.collection_rate }}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ month.contributors }}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                    {{ month.performance === 'Excellent' ? 'bg-green-100 text-green-800' : 
                       month.performance === 'Good' ? 'bg-blue-100 text-blue-800' :
                       month.performance === 'Fair' ? 'bg-yellow-100 text-yellow-800' :
                       month.performance === 'Poor' ? 'bg-orange-100 text-orange-800' :
                       'bg-red-100 text-red-800' }}">
                    {{ month.performance }}
                  </span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Insights -->
      <div class="bg-white shadow-sm rounded-lg overflow-hidden border border-gray-100">
        <div class="px-6 py-4 border-b border-gray-100">
          <h2 class="text-xl font-semibold text-gray-800">Key Insights</h2>
        </div>
        <div class="p-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Best Quarter -->
            <div class="border-l-4 border-green-400 pl-4">
              <h3 class="text-lg font-medium text-gray-900 mb-2">Best Quarter</h3>
              <p class="text-gray-600">{{ analysisData.insights.bestQuarter?.quarterLabel || 'N/A' }}</p>
              <div class="mt-2">
                <p class="text-sm text-gray-500">Collected: {{
                  analysisData.insights.bestQuarter?.totalCollectedFormatted || 'N/A' }}</p>
                <p class="text-sm text-gray-500">Rate: {{ analysisData.insights.bestQuarter?.averageCollectionRate ||
                  'N/A' }}%</p>
              </div>
            </div>

            <!-- Worst Quarter -->
            <div class="border-l-4 border-red-400 pl-4">
              <h3 class="text-lg font-medium text-gray-900 mb-2">Worst Quarter</h3>
              <p class="text-gray-600">{{ analysisData.insights.worstQuarter?.quarterLabel || 'N/A' }}</p>
              <div class="mt-2">
                <p class="text-sm text-gray-500">Collected: {{
                  analysisData.insights.worstQuarter?.totalCollectedFormatted || 'N/A' }}</p>
                <p class="text-sm text-gray-500">Rate: {{ analysisData.insights.worstQuarter?.averageCollectionRate ||
                  'N/A' }}%</p>
              </div>
            </div>

            <!-- Trend -->
            <div class="border-l-4 border-indigo-400 pl-4">
              <h3 class="text-lg font-medium text-gray-900 mb-2">Trend Direction</h3>
              <div class="flex items-center">
                <span class="text-gray-600">{{ analysisData.insights.trendDirection }}</span>
                <svg *ngIf="analysisData.insights.trendDirection === 'Improving'" class="h-5 w-5 text-green-500 ml-2"
                  fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
                </svg>
                <svg *ngIf="analysisData.insights.trendDirection === 'Declining'" class="h-5 w-5 text-red-500 ml-2"
                  fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                </svg>
              </div>
              <p class="text-sm text-gray-500 mt-2">Based on last 3 months</p>
            </div>

            <!-- Consistency -->
            <div class="border-l-4 border-yellow-400 pl-4">
              <h3 class="text-lg font-medium text-gray-900 mb-2">Consistency</h3>
              <p class="text-gray-600">Score: {{ analysisData.insights.consistencyScore }}/100</p>
              <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
                <div class="bg-indigo-600 h-2.5 rounded-full"
                  [style.width]="analysisData.insights.consistencyScore + '%'"></div>
              </div>
              <p class="text-sm text-gray-500 mt-1">Higher is better (lower variance)</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Charts Section -->
      <div class="charts-section">
        <!-- Monthly Trend Line Chart -->
        <div class="chart-container mb-6">
          <h3 class="text-lg font-semibold mb-4">Monthly Trend Analysis</h3>
          <div class="bg-white p-4 rounded-lg shadow">
            <canvas baseChart [data]="lineChartData" [options]="lineChartOptions" [legend]="lineChartLegend"
              type="line">
            </canvas>
          </div>
        </div>

        <!-- Contributor Trend Line Chart -->
        <div class="chart-container mb-6"
          *ngIf="contributorTrendLineData.labels && contributorTrendLineData.labels.length > 0">
          <h3 class="text-lg font-semibold mb-4">Contributor Trend</h3>
          <div class="bg-white p-4 rounded-lg shadow">
            <canvas baseChart [data]="contributorTrendLineData" 
              [legend]="lineChartLegend" type="line">
            </canvas>
          </div>
        </div>


        <!-- Quarterly Comparison Bar Chart -->
        <div class="chart-container mb-6"
          *ngIf="quarterlyComparisonBarData.labels && quarterlyComparisonBarData.labels.length > 0">
          <h3 class="text-lg font-semibold mb-4">Quarterly Comparison</h3>
          <div class="bg-white p-4 rounded-lg shadow">
            <canvas baseChart [data]="quarterlyComparisonBarData" [options]="quarterlyComparisonBarOptions"
              [legend]="barChartLegend" type="bar">
            </canvas>
          </div>
        </div>

      </div>

    </div>
  </div>
</div>